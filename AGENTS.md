# x402 Transaction Structures

## Overview

This document describes the exact transaction structures generated by the `/prepare` endpoint for different scenarios.

## Transaction Signers

### Non-Trustless Flow

**Non-Crossmint Wallet (facilitator pays fees):**
```
Signers:
  [0] Facilitator (fee payer)
  [1] Client wallet (token authority)

Instructions:
  1. SPL Token Transfer (client → payTo)
```

**Crossmint Wallet (self-paying fees):**
```
Signers:
  [0] Crossmint wallet (fee payer + token authority)

Instructions:
  1. SPL Token Transfer (client → payTo)
```

### Trustless Flow

**Non-Crossmint Wallet (facilitator pays fees):**
```
Signers:
  [0] Facilitator (fee payer + job registrant authority)
  [1] Client wallet (token authority)

Instructions:
  1. SPL Token Transfer (client → payTo)
  2. register_job (creates on-chain job record)
```

**Crossmint Wallet (self-paying fees):**
```
Signers:
  [0] Crossmint wallet (fee payer + token authority + job registrant)

Instructions:
  1. SPL Token Transfer (client → payTo)
  2. register_job (creates on-chain job record)
```

## Key Insight

For Crossmint wallets, if we set the **Crossmint wallet itself as the fee payer**, the transaction becomes **single-signer** regardless of whether trustless is enabled.

This works because:
1. Fee payer = Crossmint wallet
2. Token transfer authority = Crossmint wallet
3. Job registrant (if trustless) = Crossmint wallet

All three roles are the same address, so only ONE signature is needed.

## Why Multi-Sig Was Initially Considered

The original implementation had:
- Facilitator as fee payer (always)
- Client wallet as token authority

This created a 2-signer transaction that the Crossmint API couldn't handle because:
1. Crossmint signs its own wallet's transactions
2. But couldn't provide the facilitator's signature

The solution: Make Crossmint wallets pay their own fees (single-signer).

## /prepare Endpoint Behavior

| Wallet Type | enableTrustless | Fee Payer | Signers |
|-------------|-----------------|-----------|---------|
| Non-Crossmint | false | Facilitator | 2 (facilitator + client) |
| Non-Crossmint | true | Facilitator | 2 (facilitator + client) |
| Crossmint | false | Crossmint wallet | 1 (client only) |
| Crossmint | true | Crossmint wallet | 1 (client only) |

## register_job Instruction Accounts

```
Accounts:
  [0] job_record (PDA, writable) - The job ID
  [1] payer (signer, writable) - Pays rent for job_record
  [2] client (signer) - The wallet making the payment
  [3] system_program
  [4] trustless_program
```

For Crossmint self-paying flow:
- `payer` = Crossmint wallet
- `client` = Crossmint wallet
- Same address, one signature needed

## Crossmint API Integration

### API Endpoint

```
POST https://staging.crossmint.com/api/2025-06-09/wallets/{walletAddress}/transactions
```

### Headers

```json
{
  "Content-Type": "application/json",
  "X-API-KEY": "{CROSSMINT_API_KEY}"
}
```

### Request Body

```json
{
  "params": {
    "transaction": "{base58_encoded_versioned_transaction}"
  }
}
```

### Transaction Encoding

The transaction is sent as a **VersionedTransaction** (v0) serialized to base58:

```
Byte layout:
[0]        = numRequiredSignatures (1 for single-signer)
[1-64]     = empty signature placeholder (64 zero bytes)
[65...]    = transaction message bytes

Message bytes structure (v0):
[0]        = 0x80 (version prefix for v0)
[1]        = numRequiredSignatures
[2]        = numReadonlySignedAccounts
[3]        = numReadonlyUnsignedAccounts
[4...]     = static account keys
...        = recent blockhash
...        = instructions
...        = address table lookups (if any)
```

### Polling for Completion

After creating the transaction, poll for status:

```
GET https://staging.crossmint.com/api/2025-06-09/wallets/{walletAddress}/transactions/{transactionId}
```

Crossmint signs AND submits the transaction. On success, the response includes:
```json
{
  "status": "success",
  "onChain": {
    "txId": "{solana_signature}"
  }
}
```

## Crossmint + Trustless Support

### How Crossmint Wraps Transactions

When Crossmint signs and submits a transaction, it wraps the entire transaction inside their smart wallet program (`SMRTzfY6DfH5ik3TKiyLFfXexV8uSG3d2UksSCYdunG`).

**What we send:**
```
Instructions:
  [0] SetComputeUnitPrice
  [1] SetComputeUnitLimit
  [2] SPL Token Transfer
  [3] register_job
```

**What actually executes on-chain:**
```
Instructions:
  [0] AdvanceNonceAccount (System Program)
  [1] SetComputeUnitLimit (Compute Budget)
  [2] ExecuteTransactionSync (Crossmint smart wallet)
      └── CPI [0] SPL Token Transfer
      └── CPI [1] register_job
```

### How the Trustless Program Handles Crossmint Transactions

The trustless program detects Crossmint-wrapped transactions by searching the first 5 top-level instructions for the Crossmint smart wallet program ID:

```rust
// In trustless program (lib.rs)
let crossmint_wallet_pubkey = "SMRTzfY6DfH5ik3TKiyLFfXexV8uSG3d2UksSCYdunG";

let mut is_crossmint_wrapped = false;
for idx in 0..5 {
    if let Ok(ix) = load_instruction_at_checked(idx, &ixs) {
        if ix.program_id == crossmint_wallet_pubkey {
            is_crossmint_wrapped = true;
            break;
        }
    }
}
```

When a Crossmint-wrapped transaction is detected:

1. **Skips transfer instruction verification** - Cannot parse inner CPIs from the instruction sysvar
2. **Uses provided payment amount** - The `crossmint_payment_amount` parameter is trusted
3. **Uses PDA signing for agent creation** - `CpiContext::new_with_signer` for lazy agent account creation
4. **Fee payer funds all accounts** - Agent account creation uses `fee_payer` instead of `client_wallet`

### Verification Flow Changes

The verification flow (`packages/x402/src/schemes/exact/svm/facilitator/verify.ts`) also handles Crossmint wallets differently:

1. **Skips simulation** - For Crossmint wallets, simulation without signatures may fail due to missing accounts
2. **Skips facilitator signing** - Single-signer flow means only Crossmint wallet signs
3. **Uses `simulateTransactionWithoutSigning` or skips entirely** - Crossmint handles actual execution

### Current Status

| Flow | Crossmint Support | Notes |
|------|-------------------|-------|
| Non-trustless | **WORKS** | Simple token transfer |
| Trustless | **WORKS** | Crossmint wrapper detection + trusted payment amount |

## Test Results

### Non-Trustless Crossmint Payment
- Status: **PASS**
- Transaction size: 444 bytes
- Single signer (Crossmint wallet)

### Trustless Crossmint Payment
- Status: **PASS**
- Transaction size: 788 bytes
- Single signer (Crossmint wallet)
- Note: Job ID extraction from wrapped transactions may not work (warning shown)

## Known Failure Modes & Testing

### Failure Mode 1: DeclaredProgramIdMismatch (Anchor Error 4100)

**Symptoms:**
```
Error Code: DeclaredProgramIdMismatch
Error Number: 4100
```

**Root Cause:** The deployed program binary has a different `declare_id!` than the address it was deployed to. This happens when:
- The program is rebuilt without using the same keypair
- The keypair in `Anchor.toml` doesn't match the deployed address
- The `declare_id!` macro in `lib.rs` doesn't match the keypair

**Prevention:**
- Always verify `declare_id!` matches `Anchor.toml` program ID
- Use `solana program show <PROGRAM_ID>` to verify deployed program authority
- Run E2E tests against devnet before merging

**Test Coverage:**
- Unit tests: ❌ Cannot catch (mocked)
- E2E tests: ✅ Would catch immediately on first CPI call

---

### Failure Mode 2: InvalidTransferProgramId (Error 6006)

**Symptoms:**
```
Error Code: InvalidTransferProgramId
Error Number: 6006
Error Message: Transfer instruction program ID does not match token program.
```

**Root Cause:** The trustless program searches for the Crossmint wrapper at a specific instruction index, but Crossmint prepends system instructions, shifting the wrapper to a different index.

**What we expect:**
```
[0] ExecuteTransactionSync (Crossmint)  <- Check index 0
```

**What actually happens:**
```
[0] AdvanceNonceAccount (System Program)
[1] SetComputeUnitLimit (Compute Budget)
[2] ExecuteTransactionSync (Crossmint)  <- Wrapper is at index 2!
```

**Prevention:**
- Search multiple instruction indices (currently first 5) for Crossmint wrapper
- Don't assume fixed instruction ordering from third-party systems

**Test Coverage:**
- Unit tests: ❌ Cannot catch (mocked, doesn't simulate Crossmint wrapping)
- E2E tests: ✅ Would catch when submitting through real Crossmint API

---

### Failure Mode 3: Cross-program Invocation Unauthorized Signer

**Symptoms:**
```
Error: Cross-program invocation with unauthorized signer or writable account
```

**Root Cause:** When creating accounts via CPI (like lazy agent account creation), the program must:
1. Use `CpiContext::new_with_signer` with proper PDA seeds
2. Fund from an account that has signer privileges in the current CPI context

In Crossmint-wrapped transactions:
- `client_wallet` does NOT have signer privileges forwarded through CPI
- `fee_payer` DOES have signer privileges
- PDA accounts must be signed using `&[seeds]`

**Prevention:**
```rust
// WRONG: Using client_wallet and no PDA seeds
CpiContext::new(
    system_program,
    CreateAccount { from: client_wallet, to: agent_account }
)

// CORRECT: Using fee_payer with PDA seeds
let seeds = &[b"agent", agent_wallet.key().as_ref(), &[bump]];
CpiContext::new_with_signer(
    system_program,
    CreateAccount { from: fee_payer, to: agent_account },
    &[seeds]
)
```

**Test Coverage:**
- Unit tests: ❌ Cannot catch (mocked, no real CPI)
- E2E tests: ✅ Would catch on first account creation attempt

---

### Current Test Matrix

| Test Type | Location | What It Catches |
|-----------|----------|-----------------|
| Unit tests (mocked) | `packages/x402/src/**/*.test.ts` | Logic errors, type errors |
| Test harness (manual) | `test-harness/src/` | Real Crossmint behavior, on-chain errors |
| Trustless tests (manual) | `trustless/tests/` | Contract logic, PDA derivation |

### Testing Gaps

1. **No CI/CD integration tests** - E2E tests exist but aren't automated
2. **No local validator tests** - Could use `solana-test-validator` with mocked programs
3. **No Crossmint wrapper simulation** - Unit tests can't simulate Crossmint's transaction wrapping

### Recommended Test Strategy

Before deploying trustless program changes:

1. **Build and verify program ID:**
   ```bash
   cd trustless && anchor build
   # Verify declare_id! matches Anchor.toml
   ```

2. **Deploy to devnet:**
   ```bash
   solana program deploy target/deploy/trustless.so --program-id <KEYPAIR>
   ```

3. **Run E2E tests:**
   ```bash
   cd test-harness && npx tsx src/crossmint-tx-test.ts
   ```

4. **Verify both flows:**
   - Non-trustless Crossmint payment
   - Trustless Crossmint payment (with agent creation)
