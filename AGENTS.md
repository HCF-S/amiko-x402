# x402 Transaction Structures

## Overview

This document describes the exact transaction structures generated by the `/prepare` endpoint for different scenarios.

## Transaction Signers

### Non-Trustless Flow

**Non-Crossmint Wallet (facilitator pays fees):**
```
Signers:
  [0] Facilitator (fee payer)
  [1] Client wallet (token authority)

Instructions:
  1. SPL Token Transfer (client → payTo)
```

**Crossmint Wallet (self-paying fees):**
```
Signers:
  [0] Crossmint wallet (fee payer + token authority)

Instructions:
  1. SPL Token Transfer (client → payTo)
```

### Trustless Flow

**Non-Crossmint Wallet (facilitator pays fees):**
```
Signers:
  [0] Facilitator (fee payer + job registrant authority)
  [1] Client wallet (token authority)

Instructions:
  1. SPL Token Transfer (client → payTo)
  2. register_job (creates on-chain job record)
```

**Crossmint Wallet (self-paying fees):**
```
Signers:
  [0] Crossmint wallet (fee payer + token authority + job registrant)

Instructions:
  1. SPL Token Transfer (client → payTo)
  2. register_job (creates on-chain job record)
```

## Key Insight

For Crossmint wallets, if we set the **Crossmint wallet itself as the fee payer**, the transaction becomes **single-signer** regardless of whether trustless is enabled.

This works because:
1. Fee payer = Crossmint wallet
2. Token transfer authority = Crossmint wallet
3. Job registrant (if trustless) = Crossmint wallet

All three roles are the same address, so only ONE signature is needed.

## Why Multi-Sig Was Initially Considered

The original implementation had:
- Facilitator as fee payer (always)
- Client wallet as token authority

This created a 2-signer transaction that the Crossmint API couldn't handle because:
1. Crossmint signs its own wallet's transactions
2. But couldn't provide the facilitator's signature

The solution: Make Crossmint wallets pay their own fees (single-signer).

## /prepare Endpoint Behavior

| Wallet Type | enableTrustless | Fee Payer | Signers |
|-------------|-----------------|-----------|---------|
| Non-Crossmint | false | Facilitator | 2 (facilitator + client) |
| Non-Crossmint | true | Facilitator | 2 (facilitator + client) |
| Crossmint | false | Crossmint wallet | 1 (client only) |
| Crossmint | true | Crossmint wallet | 1 (client only) |

## register_job Instruction Accounts

```
Accounts:
  [0] job_record (PDA, writable) - The job ID
  [1] payer (signer, writable) - Pays rent for job_record
  [2] client (signer) - The wallet making the payment
  [3] system_program
  [4] trustless_program
```

For Crossmint self-paying flow:
- `payer` = Crossmint wallet
- `client` = Crossmint wallet
- Same address, one signature needed
