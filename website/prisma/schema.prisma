// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["x402"]
}

model Agent {
  wallet    String @id @unique // Wallet pubkey
  name      String?
  description String?

  // On-chain data
  metadata_uri String?
  metadata_json Json?
  active Boolean @default(true)
  auto_created Boolean @default(false)
  
  // Reputation tracking
  total_weighted_rating Decimal @default(0) @db.Decimal(39, 0)  // u128 equivalent
  total_weight Decimal @default(0) @db.Decimal(39, 0)           // u128 equivalent
  avg_rating Float @default(0)                                   // f32
  last_update DateTime?
  job_count Int @default(0)                                      // u32
  feedback_count Int @default(0)                                 // u32

  services AgentServices[]
  jobs          JobRecord[]
  feedbacks     FeedbackRecord[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("agents")
  @@schema("x402")
}

model AgentServices {
  id          String @id @default(cuid())
  agent_wallet String
  url         String

  name        String?
  description String?
  method      String?  // GET, POST, PUT, DELETE, PATCH
  
  metadata    Json?    // x402 API response

  agent Agent @relation(fields: [agent_wallet], references: [wallet])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([agent_wallet, url])
  @@map("agent_services")
  @@schema("x402")
}

model JobRecord {
  id               String @id        // Pubkey from chain (PDA)
  client_wallet    String            // Client wallet pubkey
  agent_wallet     String            // Agent wallet pubkey
  payment_amount   Int               // u32 (max ~4,294 USDC with 6 decimals)
  created_at_chain DateTime          // i64 timestamp from chain
  
  agent            Agent @relation(fields: [agent_wallet], references: [wallet])
  feedback         FeedbackRecord?  // One-to-one: one job can have at most one feedback

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("job_records")
  @@schema("x402")
}

model FeedbackRecord {
  id                String @id      // Pubkey from chain (PDA)
  job_id            String @unique  // One-to-one: unique job_id ensures one feedback per job
  client_wallet     String          // Denormalized from JobRecord for easier querying
  agent_wallet      String          // Denormalized from JobRecord for easier querying
  rating            Int             // u8
  comment_uri       String?         // Optional<String>
  timestamp         DateTime        // i64 timestamp from chain
  
  job               JobRecord @relation(fields: [job_id], references: [id])
  agent             Agent @relation(fields: [agent_wallet], references: [wallet])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("feedback_records")
  @@schema("x402")
}
